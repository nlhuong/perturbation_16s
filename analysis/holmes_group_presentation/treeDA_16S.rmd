---
title: "Resilience Study 16S data: tree Discriminant Analysis"
author: 
  - name: Lan Huong Nguyen
    affiliation: Institute for Computational and Mathematical Engineering, Stanford University, CA 94305
keywords: microbiome, metatranscriptomics.
date: "`r BiocStyle::doc_date()`"
output: 
  BiocStyle::html_document:
    toc_float: true
    df_print: paged
vignette: >
  %\VignetteIndexEntry{Gene expression time course data analysis}
  %\VignetteEngine{knitr::rmarkdown}
---


```{r style, echo=FALSE, message=FALSE, warning=FALSE, results="asis"}
library("BiocStyle")
library("rmarkdown")
options(width = 200, stringsAsFactors = FALSE) 
knitr::opts_chunk$set(
  message = FALSE, error = FALSE, warning = FALSE, 
  fig.width = 8, fig.height = 6,
  fig.path = "../figs/holmes_group_presentation/treeDA/", 
  dev='png') 
```

```{r setup, warning=FALSE, message=FALSE}
#rm(list = ls())
library("DESeq2")
library("viridis")
library("RColorBrewer")
library("ggplot2")
library("dplyr")
library("phyloseq")
library("treeDA")
library("adaptiveGPCA")

datadir <- "/scratch/PI/sph/resilience/"
curdir <- getwd()
resfile <- "results/treeDA_res16S.rda"
source('utils.R')
saveRES <- FALSE
```

```{r}
theme_set(theme_bw())
theme_update(
   panel.border = element_rect(size = 0.5),
   legend.position = "bottom",
   text = element_text(size = 15),
   strip.background = element_blank()
)
```

```{r}
processed_datafile <- "results/processed_physeq.rda"
load(processed_datafile)
load("results/ordinate_16S.rda")
```

```{r}
dds <- phyloseq_to_deseq2(ps, design = ~ 1)
dds <- estimateSizeFactors(dds, type = "poscounts")
norm_counts <- counts(dds, normalized = TRUE)
ps_norm <- ps
otu_table(ps_norm) <- otu_table(norm_counts, taxa_are_rows = TRUE)
```


# Tree Discriminant Analysis

## Response to Diet

```{r}
minTaxaSum <- 5
diet <- subset_samples(ps_norm, grepl("Diet", Group))
diet <- subset_samples(
  diet, !grepl("MidAbx", Abx_Interval) & !grepl("PostAbx", Abx_Interval) &
    !grepl("PostCC", CC_Interval))

diet <- subset_taxa(diet, taxa_sums(diet) > minTaxaSum)
diet_SMP <- data.frame(diet@sam_data) %>%
  mutate(Samp_Date = as.Date(Samp_Date))
```

```{r exp-design, fig.width=8, fig.height=8}
new_intv_levs <- unique(diet_SMP$Interval)
colors <- colorRampPalette(brewer.pal(8, "Dark2"))(length(new_intv_levs)-2)
colors <- c("grey57", "red", colors)
names(colors) <- c("NoInterv", "MidDiet", "PostDiet_PreAbx", "PostDiet_PreCC",
                   "PostDiet_PreCC_PreAbx")
ggplot(
  diet_SMP, aes(y = Subject, x = Diet_RelDay)) +
  geom_point(
      aes(color = Interval, fill = Interval), 
      pch = 124, size = 3) +
    facet_grid(Group ~ ., scales = "free", space = "free") +
    scale_color_manual(values = colors) +
    theme(legend.direction = "horizontal", legend.box = "vertical",
          strip.text.y = element_text(angle=270, size = 10)) +
    guides(color = guide_legend(nrow = 2 , override.aes = list(size=3, pch = 16)))
```

### Multiple Classes

```{r}
sample_data(diet)$type <- with(sample_data(diet), 
  memisc::cases(
    Diet_RelDay < 0                      -> "PreDiet",
    Diet_RelDay < 7 & Diet_RelDay >= 0   -> "MidDiet",
    Diet_RelDay < 40 & Diet_RelDay >= 7  -> "PostDiet",
    Diet_RelDay >= 40                    -> "Recovery"
  )
)
```

```{r}
table(sample_data(diet)$type)
```


```{r}
diet.treeda.mult = treeda(
  response = sample_data(diet)$type,
  predictors = t(otu_table(diet)),
  tree = phy_tree(diet), p = 50)
beta <- as.numeric(diet.treeda.mult$leafCoefficients$beta)
```

```{r}
nTaxa <- 10
taxtab <- data.frame(as(tax_table(diet), "matrix"), stringsAsFactors = FALSE)
freq_family <- taxtab %>%
  filter(!is.na(Family)) %>%
  group_by(Family) %>%
  summarise(Freq = n()) %>%
  arrange(desc(Freq))
taxa_levels <- unique(
  c(freq_family$Family[1:nTaxa], taxtab$Family[abs(beta) > 1e-6]))
taxtab$family <- factor(taxtab$Family, levels = taxa_levels)
```

```{r}
diet.treeda.mult
```

```{r}
ggplot(data.frame(sample_data(diet), projections = diet.treeda.mult$projections)) +
  geom_point(aes(x = Subject, y = projections.1, color = type)) +
  theme(axis.text.x = element_text(angle = 90))
```

```{r}
ggplot(data.frame(sample_data(diet), projections = diet.treeda.mult$projections)) +
  geom_point(aes(x = Subject, y = projections.2, color = type)) +
  theme(axis.text.x = element_text(angle = 90))
```


```{r}
ggplot(data.frame(sample_data(diet), projections = diet.treeda.mult$projections)) +
  geom_point(aes(x = Subject, y = projections.3, color = type)) +
  theme(axis.text.x = element_text(angle = 90))
```


```{r}
plot_coefficients(diet.treeda.mult, color = rep(taxtab$family, 3))
```




Cross Validation

```{r, eval =  saveRES}
set.seed(0)
diet.treedacv = treedacv(
  response = sample_data(diet)$type,
  predictors = t(otu_table(diet)),
  tree = phy_tree(diet),
  folds = 10, pvec = seq(10, 200, by = 10))
diet.treedacv
```


```{r}
# plot(diet.treedacv)
```

```{r, eval = FALSE}
diet.treeda.opt = treeda(
  response = sample_data(diet)$type,
  predictors = t(otu_table(diet)),
  tree = phy_tree(diet), p = #fill in)
diet.treeda.opt 
```

```{r, eval = FALSE}
save(list = c("diet.treedacv", "diet"), file = resfile)
```



### Two classes only

```{r}
diet_change <- subset_samples(diet, type %in%  c("PostDiet", "PreDiet")) 
diet_change <- subset_taxa(diet_change, taxa_sums(diet_change) > 0)
diet_change
```


```{r}
diet.treeda = treeda(
  response = sample_data(diet_change)$type,
  predictors = t(otu_table(diet_change)),
  tree = phy_tree(diet_change), 
  p = 150)
```

```{r}
diet.treeda
```

```{r}
ggplot(data.frame(sample_data(diet_change), 
                  projections = diet.treeda$projections)) +
  geom_point(aes(x = Subject, y = projections, color = type)) +
  theme(axis.text.x = element_text(angle = 90))
```


```{r}
nTaxa <- 10
beta <- as.numeric(diet.treeda$leafCoefficients$beta)
taxtab <- data.frame(as(tax_table(diet_change), "matrix"), stringsAsFactors = FALSE)
freq_family <- taxtab %>%
  group_by(Family) %>%
  summarise(Freq = n()) %>%
  filter(!is.na(Family)) %>%
  arrange(desc(Freq))
taxa_levels <- unique(
  c(freq_family$Family[1:nTaxa], taxtab$Family[abs(beta) > 1e-6]))
taxtab$family <- factor(taxtab$Family, levels = taxa_levels)
```


```{r}
plot_coefficients(diet.treeda, color = taxtab$family)
```



Cross Validation

```{r, eval = FALSE}
set.seed(0)
diet_change.treedacv = treedacv(
  response = sample_data(diet_change)$type,
  predictors = t(otu_table(diet_change)),
  tree = phy_tree(diet_change),
  folds = 10, pvec = seq(10, 200, by = 10))
diet_change.treedacv
```


```{r, eval = FALSE}
plot(diet_change.treedacv)
```

```{r, eval = FALSE}
diet_change.treeda.opt = treeda(
  response = sample_data(diet_change)$type,
  predictors = otu_table(diet_change),
  tree = phy_tree(diet_change), p = # fill inn)
diet_change.treeda.opt 
```


```{r, eval = FALSE}
save(list = c("diet.treedacv", "diet", "diet_change.treedacv", "diet_change"), file = resfile)
```



## Response to Antibiotics

```{r}
minTaxaSum <- 5
abx <- subset_samples(ps_norm, grepl("Abx", Group))
abx <- subset_samples(abx, 
  !grepl("MidDiet", Diet_Interval) & !grepl("PreDiet", Diet_Interval) &
    !grepl("PreCC", CC_Interval))

abx <- subset_taxa(abx, taxa_sums(abx) > minTaxaSum)
abx_SMP <- data.frame(abx@sam_data) %>%
  mutate(Samp_Date = as.Date(Samp_Date))
abx
```

```{r exp-design, fig.width=8, fig.height=8}
new_intv_levs <- unique(abx_SMP$Interval)
colors <- colorRampPalette(brewer.pal(8, "Dark2"))(length(new_intv_levs)-2)
colors <- c("grey57", "red", colors)
names(colors) <- c("NoInterv", "MidAbx", "PostDiet_PreAbx", 
                   "PostDiet_PostAbx", "PostDiet_PostCC_PreAbx", 
                   "PostDiet_PostCC_PostAbx", "PostAbx", "UnpAbx")
ggplot(
  abx_SMP, aes(y = Subject, x = Abx_RelDay)) +
  geom_point(
      aes(color = Interval, fill = Interval), 
      pch = 124, size = 3) +
    facet_grid(Group ~ ., scales = "free", space = "free") +
    scale_color_manual(values = colors) +
    theme(legend.direction = "horizontal", legend.box = "vertical",
          strip.text.y = element_text(angle=270, size = 10)) +
    guides(color = guide_legend(nrow = 3 , override.aes = list(size=3, pch = 16)))
```


### Multiple Classes

```{r}
sample_data(abx)$type <- with(sample_data(abx), 
  memisc::cases(
    Abx_RelDay < 0                    -> "PreAbx",
    Abx_RelDay < 7 & Abx_RelDay >=0   -> "MidAbx",
    Abx_RelDay < 40 & Abx_RelDay >= 7 -> "PostAbx",
    Abx_RelDay >= 40                  -> "Recovery"
  )
)
```

```{r}
table(sample_data(abx)$type)
```



```{r}
abx.treeda.mult = treeda(
  response = sample_data(abx)$type,
  predictors = t(otu_table(abx)),
  tree = phy_tree(abx), p = 50)
```

```{r}
nTaxa <- 10
beta <- as.numeric(abx.treeda.mult$leafCoefficients$beta)
taxtab <- data.frame(as(tax_table(abx), "matrix"), stringsAsFactors = FALSE)
freq_family <- taxtab %>%
  filter(!is.na(Family)) %>%
  group_by(Family) %>%
  summarise(Freq = n()) %>%
  arrange(desc(Freq))
taxa_levels <- unique(
  c(freq_family$Family[1:nTaxa], taxtab$Family[abs(beta) > 1e-6]))
taxtab$family <- factor(taxtab$Family, levels = taxa_levels)
```


```{r}
abx.treeda.mult
```

```{r}
ggplot(data.frame(sample_data(abx), projections = abx.treeda.mult$projections)) +
  geom_point(aes(x = Subject, y = projections.1, color = type)) +
  theme(axis.text.x = element_text(angle = 90))
```

```{r}
ggplot(data.frame(sample_data(abx), projections = abx.treeda.mult$projections)) +
  geom_point(aes(x = Subject, y = projections.2, color = type)) +
  theme(axis.text.x = element_text(angle = 90))
```


```{r}
ggplot(data.frame(sample_data(abx), projections = abx.treeda.mult$projections)) +
  geom_point(aes(x = Subject, y = projections.3, color = type)) +
  theme(axis.text.x = element_text(angle = 90))
```


```{r}
plot_coefficients(abx.treeda.mult, color = rep(taxtab$family, 3))
```



Cross Validation

```{r, eval = FALSE}
set.seed(0)
abx.treedacv = treedacv(
  response = sample_data(abx)$type,
  predictors = t(otu_table(abx)),
  tree = phy_tree(diet),
  folds = 10, pvec = seq(10, 200, by = 10))
abx.treedacv
```


```{r}
plot(abx.treedacv)
```

```{r, eval = FALSE}
abx.treeda.opt = treeda(
  response = sample_data(diet)$type,
  predictors = t(otu_table(diet)),
  tree = phy_tree(diet), p = #fill in)
abx.treeda.opt 
```

```{r, eval = FALSE}
save(list = c("diet.treedacv", "diet", "diet_change.treedacv", "diet_change",
              "abx.treedacv", "abx"), 
     file = resfile)
```



### Two classes only

```{r}
abx_change <- subset_samples(abx, type %in%  c("PostAbx", "PreAbx")) 
abx_change <- subset_taxa(abx_change, taxa_sums(abx_change) > 0)
abx_change
```


```{r}
abx.treeda = treeda(
  response = sample_data(abx_change)$type,
  predictors = t(otu_table(abx_change)),
  tree = phy_tree(abx_change), 
  p = 50)
```

```{r}
abx.treeda
```

```{r}
ggplot(data.frame(sample_data(abx_change), 
                  projections = abx.treeda$projections)) +
  geom_point(aes(x = Subject, y = projections, color = type)) +
  theme(axis.text.x = element_text(angle = 90))
```


```{r}
nTaxa <- 10
beta <- as.numeric(diet.treeda$leafCoefficients$beta)
taxtab <- data.frame(as(tax_table(abx_change), "matrix"), stringsAsFactors = FALSE)
freq_family <- taxtab %>%
  group_by(Family) %>%
  summarise(Freq = n()) %>%
  filter(!is.na(Family)) %>%
  arrange(desc(Freq))
taxa_levels <- unique(
  c(freq_family$Family[1:nTaxa], taxtab$Family[abs(beta) > 1e-6]))
taxtab$family <- factor(taxtab$Family, levels = taxa_levels)
```


```{r}
plot_coefficients(abx.treeda, color = taxtab$family)
```



Cross Validation

```{r, eval = FALSE}
set.seed(0)
abx_change.treedacv = treedacv(
  response = sample_data(abx_change)$type,
  predictors = t(otu_table(abx_change)),
  tree = phy_tree(abx_change),
  folds = 10, pvec = seq(10, 200, by = 10))
abx_change.treedacv
```


```{r}
plot(abx_change.treedacv)
```

```{r, eval = FALSE}
abx_change.treeda.opt = treeda(
  response = sample_data(abx_change)$type,
  predictors = t(otu_table(abx_change)),
  tree = phy_tree(abx_change), p = #fill in)
abx_change.treeda.opt 
```

```{r, eval = FALSE}
save(list = c("diet.treedacv", "diet", "diet_change.treedacv", "diet_change",
              "abx.treedacv", "abx", "abx_change.treedacv", "abx_change"), 
     file = resfile)
```








```{r}

```






```{r}
sessionInfo()
```


---
title: "Presentation Plots"
author: 
  - name: Lan Huong Nguyen
    affiliation: Institute for Computational and Mathematical Engineering, Stanford University, CA 94305
keywords: microbiome, metatranscriptomics.
date: "`r BiocStyle::doc_date()`"
output: 
  BiocStyle::html_document2:
    toc_float: true
    df_print: paged
vignette: >
  %\VignetteIndexEntry{Gene expression time course data analysis}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r style, echo=FALSE, message=FALSE, warning=FALSE, results="asis"}
rm(list = ls())
library("BiocStyle")
library("rmarkdown")
options(width = 200) 
knitr::opts_chunk$set(
  message = FALSE, error = FALSE, warning = FALSE, 
  fig.width = 8, fig.height = 6,
  fig.path = "figs/", dev='png') 
```

```{r setup}
library("tidyverse")
library("readxl")
library("data.table")
library("gridExtra")
library("RColorBrewer")

theme_set(theme_bw())
theme_update(
  text = element_text(15),
  panel.border = element_rect(size = 0.5),
  panel.grid = element_blank(),
  axis.ticks = element_blank(),
  legend.title = element_text(size = 10),
  legend.text = element_text(size = 10),
  legend.position = "bottom",
  strip.background = element_blank()
)
```

Study Design {#study-design .unnumbered}
========================================


```{r}
# loading sample info
datadir <- "/scratch/PI/sph/resilience/"
smpinfo_file <- file.path(datadir, "sample_info/Mapping_Files_26March2018.xlsx") 

# Measurement Information
meas <- read_xlsx(smpinfo_file, sheet = "Meas")
colnames(meas) <- meas[1, ]
meas <- meas[-1, ] %>%
  rename(Samp_ID = SampID) %>%
  select(Meas_ID:Meas_Type)

```

```{r}
# Sample Information
interv_levs <- c("NoInterv", 
                 "PreDiet", "MidDiet", "PostDiet", 
                 "PreCC", "MidCC", "PostCC", 
                 "PreAbx", "MidAbx", "PostAbx", "UnpAbx")

samp <- read_xlsx(smpinfo_file, "Samp", skip = 1) 
samp <- samp %>%
  filter(Samp_Type != "ExtrCont") %>%
  mutate(
    Diet_Interval = ifelse(Diet_Interval == "NA", "NoInterv", Diet_Interval),
    CC_Interval = ifelse(CC_Interval == "NA", "NoInterv", CC_Interval),
    Abx_Interval = ifelse(Abx_Interval == "NA", "NoInterv", Abx_Interval),
    Abx_Interval = ifelse(Abx_Interval == "Midabx","MidAbx", Abx_Interval),
    Diet_Interval = factor(Diet_Interval, interv_levs),
    CC_Interval = factor(CC_Interval, interv_levs),
    Abx_Interval = factor(Abx_Interval, interv_levs),
    Interval = paste0(Diet_Interval, "_", CC_Interval, "_", Abx_Interval)) %>%
  select(Samp_ID:Abx_Interval, Interval) 
  

samp <- samp %>%
  mutate(
    Interval = gsub("NoInterv_NoInterv_NoInterv", "NoInterv", Interval),
    Interval = gsub("NoInterv_", "", Interval),
    Interval = gsub("_NoInterv", "", Interval),
    Interval = ifelse(!grepl("Post", Interval) & !grepl("Mid", Interval) &
                      !grepl("UnpAbx", Interval),
                      "NoInterv", Interval),
    Interval = ifelse(grepl("MidAbx", Interval), "MidAbx", Interval),
    Interval = ifelse(grepl("MidDiet", Interval), "MidDiet", Interval),
    Interval = ifelse(grepl("MidCC", Interval), "MidCC", Interval)
  ) 

new_intv_levs <- unique(samp$Interval) 
samp <- samp %>%
  mutate(
    Interval = factor(Interval, new_intv_levs)
  )

# Fix date issues
samp <- samp %>% 
  mutate_at(.funs = function(x) {as.Date(as.numeric(x), origin="1899-12-30")},
              .vars = select(samp, contains("Date")) %>% colnames())


```

```{r}
# Subject Data
subj_data <- read_excel(smpinfo_file,
                        sheet = "SubjNoRagged", skip = 1, 
                        col_types = c("text", rep("date", 4), rep("guess", 864)))  %>%
  mutate(CC = ifelse(!is.na(CC_Date), "CC", NA),
         Diet = ifelse(!is.na(Diet_StartDate), "Diet", NA),
         Abx = ifelse(!is.na(Abx_StartDate), "Abx", NA),
         Group = sapply(1:nrow(.), function(i) {
           z <- c(CC[i], Diet[i], Abx[i])
           z <- paste(z[!is.na(z)], collapse = "_")
           if(z == "") z <- "NoIntv"
           return(z)
           })) %>%
  select(Subject, Group, First_Sample_Date, CC_Date, Diet_StartDate, Abx_StartDate,
         Age:BirthYear)
head(subj_data)
```

```{r}
meas_info <- meas %>%
  left_join(samp) %>%
  left_join(subj_data) %>%
  filter(
    !startsWith(Subject, "AA"),
    Meas_Type %in% c("16S", "MetaG", "MetaT"))
```


```{r}
smp_modality_count <- meas_info %>%
  select(Meas_ID, Samp_ID, Meas_Type) %>%
  group_by(Samp_ID) %>%
  summarise(
    modalities = paste0(unique(Meas_Type), collapse = "_"),
    modality_count = n()
  ) %>%
  mutate(
    modalities = ifelse(modalities == "MetaT_MetaG_16S", "16S_MetaG_MetaT", modalities)
  )
  
df2plot <- meas_info %>%
  left_join(smp_modality_count) %>% 
  select(Meas_ID, Samp_ID, Subject, Samp_Date, Meas_Type, 
         Group, Interval, modalities, modality_count) %>%
  filter(!grepl("NA", Subject))
```


```{r, fig.width=10}
colors <- colorRampPalette(brewer.pal(8, "Set3"))(length(new_intv_levs)-2)
colors <- c("grey57", "red", colors)
names(colors) <- c("NoInterv", "UnpAbx", 
                   setdiff(new_intv_levs, c("NoInterv", "UnpAbx")))


for(gr in unique(df2plot$Group)) {
  plt <- ggplot(df2plot %>% filter(Group == gr)) +
  geom_point(
    pch = 21, color = "grey77",
    aes(y = Subject, x = Samp_Date, #color = Interval,
        fill = Interval, size = modality_count) #, pch = modalities)
  ) +
  #facet_grid(Group ~ ., scales = "free", space = "free") +
  scale_fill_manual(values = colors) +
 # scale_color_manual(values = colors) +
  scale_size_continuous(range = c(3, 6)) +
  theme(legend.direction = "horizontal", legend.box = "vertical") +
  guides(fill = guide_legend(override.aes = list(size=5)),
         size = guide_legend(override.aes = list(color="black")))
  print(plt + ggtitle(gr))
}

```


Read Coverage {#read-coverage .unnumbered}
========================================

Here we summarize the read coverage statistics for all data modalities.

16S {#read-coverage-16S .unnumbered}
------------------------------------

```{r}
physeqfile <- file.path(datadir, "16S/phyloseq/perturb_physeq_22Jan18.rds")
stats16sfile <- file.path(datadir, "16S/16S_dada2_results/track_all_pools.csv")
ps <- readRDS(physeqfile)
ps
stats16s <-read.csv(stats16sfile, row.names = 1)
head(stats16s)
```

```{r}

```




MetaGenomics {#read-coverage-metag .unnumbered}
------------------------------------

```{r}

```

MetaTranscriptomics {#read-coverage-metat .unnumbered}
------------------------------------

```{r}

```


```{r}
sessionInfo()
```


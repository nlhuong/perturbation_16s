---
title: "Functional PCA"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("phyloseq")
library("RColorBrewer")
library("tidyverse")
library("fdapace")
source('./fda_pca_funs.R')

datadir <- "../../data/"
curdir <- getwd()
theme_set(theme_bw())
theme_update(text = element_text(20))

abx_intv_cols <- c("PreAbx" = "grey60", "MidAbx" = "#E41A1C", 
                   "PostAbx" = "#00BFC4", "UnpAbx" = "Purple")
diet_intv_cols <- c("PreDiet" = "grey60", "MidDiet" = "#FD8D3C", "PostDiet" = "#4DAF4A")
cc_intv_cols <- c("PreCC" = "grey60", "PostCC" = "#7A0177") #"#AE017E")

intv_cols <- c(abx_intv_cols, diet_intv_cols, cc_intv_cols, "NoInterv" = "grey60")
```



# Load 

```{r}
# File generated in /perturbation_16s/analysis/analysis_summer2019/generate_phyloseq.rmd
psSubj <- readRDS("../../data/16S/phyloseq/perturb_physeq_participants_decontam_15Jul19.rds")
psSubj
# otu_table()   OTU Table:         [ 2425 taxa and 4402 samples ]
# sample_data() Sample Data:       [ 4402 samples by 40 sample variables ]
SMP <- data.frame(sample_data(psSubj))
SUBJ <- SMP %>% select(Subject, Age:BirthYear) %>% distinct()
```


```{r}
load("output/pairwise_dist_to_baseline_subj_16S.rda")
ls()
```


# Functional PCA 


```{r}
fit_dist_to_baseline <- function(
  dist_to_baseline, time_column="RelDay", 
  value_column = "dist_to_baseline", replicate_column = "Subject") 
{
  nGrid <- length(seq(min(dist_to_baseline[[time_column]]), max(dist_to_baseline[[time_column]])))
  fpca_res <- fit_fdapca(
    dist_to_baseline, time_column, value_column, replicate_column,
    cluster = FALSE, filter = FALSE, fpca_optns = list(nRegGrid = nGrid))
  
  fitted_mean <- data.frame(time = fpca_res$workGrid, value = fpca_res$mu)
  fitted_response <- fpca_fit(fpca_res) %>%
    mutate(Subject = Replicate_ID) %>%
    left_join(
      fpca_fit(fpca_res, derOptns = list(p = 1)) %>%
        mutate(Subject = Replicate_ID) %>%
        rename("deriv" = value)
    )
  return(list(res = fpca_res, mean = fpca_res, fitted = fitted_response))
}
```


```{r}
# this is because some subjects have multiple samples take the same day
bray_to_baseline_fltr <- bray_to_baseline %>% 
  filter(RelDay >= -60, RelDay <= 60) %>%
  group_by(perturbation, Subject, Group, Interval, RelDay) %>%
  summarise(n = n(), dist_to_baseline = mean(dist_to_baseline))

bray_to_baseline_fltr %>% filter(n > 1)

```

## Antibiotics

```{r}
fpca.bray.abx <- fit_dist_to_baseline(bray_to_baseline_fltr %>% filter(perturbation))

```

```{r abx-bray-fit, fig.width=12, fig.height=7}
abx_intv_cols[3] <- "#00BFC4"
ggplot(abx_bray, aes(x = Abx_RelDay.S2, y = bray)) +
  geom_line(
    data = abx_bray_response,
    aes(group = Subject, x = time, y = value),
    alpha = 0.3, size = 0.7 ) +
  geom_vline(xintercept = 0, lwd = 1, color = "orange") +
  geom_vline(xintercept = 5, lwd = 1, color = "orange") +
  # geom_point(
  #     data = abx_bray %>% filter(Abx_RelDay.S2 > bray_recov_time),
  #     color = "orange", size = 2.5) +
  geom_text(
      data = abx_bray, aes(color = Abx_Interval.S2,
                           label = Subject), size = 3, alpha = 0.7) +
  geom_line(
    data = abx_bray_mean, aes(x = time, y = value),
    color = "navy", size = 2.5) +
  scale_color_manual(values = abx_intv_cols, name = "Time Interval") +
  scale_x_continuous(name = "Days relative to Abx start date",
                     breaks = seq(-40, 120, 20),
                     labels =  seq(-40, 120, 20), limits = c(NA, NA))

```